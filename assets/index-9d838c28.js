import{P as Y,a as U,u as M,b as _,r as a,j as e,L as Z,M as P,i as A,A as ee,S as B,c as se,d as n,e as S,f as te,Q as $,g as ae,s as ne,h as re,k as oe,l as ie,m as O,B as le}from"./index-c2158f24.js";import{S as ce,D as ue,P as me}from"./SearchBtnMini-48c6685f.js";import{C as de,M as D,a as ge}from"./Container-3a9cba4f.js";const H=({isActiveMenu:o})=>{const j=U(),l=M(_),[y,x]=a.useState(!1),[u,s]=a.useState(""),[T,c]=a.useState(1),C=a.useRef(T),[t,r]=a.useState(null),[m,d]=a.useState(!1),[g,f]=a.useState(null),[I,F]=a.useState(!1),w=a.useRef(null),[K,R]=a.useState(!1),b=localStorage.getItem("userId");let N;const v=()=>{l&&(j(se({chatRoomId:l._id,userId:b})),x(!1))},J=i=>{const p=i.target,h=1,X=4;s(p.value);const L=Math.min(X,Math.max(h,p.scrollHeight/24));c(L),C.current=L,n.emit("userTyping",{isTyping:!0}),clearTimeout(N),N=setTimeout(()=>{n.emit("userTyping",{isTyping:!1})},1e3)},E=()=>{if(u.trim()==="")return;const i={userId:b,roomId:l._id,message:{messageOwner:"user",messageType:"text",messageText:u}};j({type:S,payload:i}),n.emit("userMessage",i),s(""),c(1)},k=()=>{if(t){R(!0),F(!0);const i=new FormData;i.append("chatImageURL",t),te(i).then(p=>{const h={userId:b,roomId:l._id,message:{messageOwner:"user",messageType:"image",messageText:p.imageURL}};j({type:S,payload:h}),n.emit("userMessage",h)}).catch(()=>$.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{r(null),d(!1),f(null),R(!1),F(!1)})}},W=i=>{const p=i.target.files[0];r(p),d(!0);const h=URL.createObjectURL(p);f(h)},q=()=>{w.current&&w.current.click()},Q=()=>{u.trim()!==""&&c(C.current)},V=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),I?k():E())},z=()=>{x(!y)},G=()=>{c(1),n.emit("userTyping",{isTyping:!1})};return a.useEffect(()=>{x(o)},[o]),e.jsx(e.Fragment,{children:K?e.jsx(Z,{}):e.jsxs("footer",{className:"absolute bottom-0 w-full",children:[e.jsxs("div",{className:"relative items-center bg-mainColors-staticWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:T,value:u,onChange:J,onKeyDown:V,onFocus:Q,onBlur:G}),!u&&!m&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:z,children:e.jsx(P,{colorFill:y?A.brand:A.primary})}),e.jsxs("button",{className:"icon-style",onClick:q,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:W,ref:w}),e.jsx(ee,{})]})]}),u&&e.jsx("button",{type:"submit",className:"icon-style",onClick:E,children:e.jsx(B,{})}),m&&e.jsx("button",{type:"submit",className:"icon-style",onClick:k,children:e.jsx(B,{})}),g&&e.jsx("div",{className:"bg-mainColors-staticWhite ml-5 py-5",children:e.jsx("img",{src:g,alt:"Uploaded Image"})})]}),y&&e.jsxs("div",{className:"flex gap-3 py-xs justify-center fade-in",children:[e.jsx(ce,{to:"/",disabled:l==null?void 0:l.isChatRoomProcessed,onClick:v,children:"Головне меню"}),e.jsx(ue,{to:"/",onClick:v,children:"Завершити діалог"})]})]})})};H.propTypes={isActiveMenu:Y.bool.isRequired};const xe=()=>{const o=U(),[j,l]=a.useState(!1),[y,x]=a.useState(!1),u=M(ae),s=M(_),T=M(ne),c=a.useRef(null),C=localStorage.getItem("userId");return a.useEffect(()=>{n.emit("authentication",{token:u}),l(!0)},[u]),n.on("authenticationError",({message:t})=>{$.error(t),l(!1)}),a.useEffect(()=>(n.on("closeChatByManager",({room:t})=>{o({type:re,payload:{room:t}})}),()=>{n.off("closeChatByManager")}),[o]),a.useEffect(()=>{!s&&T.isOnline===!0&&o(oe(C))},[s,o,T.isOnline,C]),a.useEffect(()=>(n.on("managerMessage",({roomId:t,message:r})=>{o({type:S,payload:{roomId:t,message:r}})}),()=>{n.off("managerMessage")}),[o]),a.useEffect(()=>(n.on("managerTyping",({isTyping:t,manager:r})=>{t&&r.id===(s==null?void 0:s.managerId)?x(!0):x(!1)}),()=>{n.off("managerTyping")}),[s==null?void 0:s.managerId]),a.useEffect(()=>(n.on("userStatusChanged",({userId:t,isOnline:r})=>{o({type:ie,payload:{userId:t,isOnline:r}})}),()=>{n.off("userStatusChanged")}),[o]),a.useEffect(()=>(n.on("managerJoinToChat",t=>{o({type:O,payload:t});const{_id:r,managerName:m,managerSurname:d}=t;if(m){const g={roomId:r,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${m} ${d}`,createdAt:Date.now()}};o({type:S,payload:g})}}),()=>{n.off("managerJoinToChat")}),[o]),a.useEffect(()=>(n.on("disconnectManager",t=>{if(s){const{_id:r,managerName:m,managerSurname:d}=s,g=t.findIndex(f=>f._id===r);if(g!==-1){o({type:O,payload:t[g]});const f={roomId:r,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${m} ${d} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};o({type:S,payload:f})}}}),()=>{n.off("disconnectManager")}),[s,o]),a.useEffect(()=>{if(c.current){const t=c.current.scrollHeight,r=c.current.clientHeight;t>r&&(c.current.scrollTop=t-r)}},[s,y]),j?e.jsxs("div",{children:[e.jsx(de,{children:e.jsxs("section",{ref:c,className:"flex flex-col gap-5 py-5 message-container",children:[s&&e.jsx(D,{type:"text",text:ge,time:s==null?void 0:s.createdAt}),s&&(s==null?void 0:s.messages.map((t,r)=>{const{_id:m=r,messageOwner:d,messageText:g,messageType:f,createdAt:I=Date.now()}=t;return e.jsx(D,{owner:d==="user"?"Ви":d==="Бот"?"Бот":`Менеджер ${s.managerName} ${s.managerSurname}`,type:f,text:g,time:I},m)})),y&&e.jsx("div",{children:e.jsx(me,{disabled:!0,children:e.jsxs("div",{className:"flex gap-xs2",children:[e.jsx("div",{className:"font-normal text-sm leading-5 text-textColors-tertiary",children:"Менеджер друкує повідомлення"}),e.jsx(le,{height:20,width:48,radius:8})]})})}),!s&&e.jsx(D,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]})}),e.jsx(H,{isActiveMenu:!s})]}):null};export{xe as default};
