import{a as k,u as R,b as v,r as a,j as e,L as Q,M as V,i as b,A as q,S as F,c as z,d as S,e as r,f as G,Q as L,g as K,h as P,k as X,l as N}from"./index-21e3694d.js";import{S as Y,D as Z}from"./SearchBtnMini-d918961c.js";import{C as ee,M as D,a as se}from"./Container-23af51e3.js";const te=()=>{const n=k(),d=R(v),[x,j]=a.useState(!1),[s,l]=a.useState(""),[y,t]=a.useState(1),o=a.useRef(y),[i,m]=a.useState(null),[u,f]=a.useState(!1),[p,w]=a.useState(null),[A,M]=a.useState(!1),C=a.useRef(null),I=localStorage.getItem("userId"),E=()=>{d&&n(z({chatRoomId:d._id,userId:I}))},U=c=>{const g=c.target,h=1,W=4;l(g.value);const T=Math.min(W,Math.max(h,g.scrollHeight/24));t(T),o.current=T},_=()=>{if(s.trim()==="")return;const c={userId:I,roomId:d._id,message:{messageOwner:"user",messageType:"text",messageText:s}};n({type:S,payload:c}),r.emit("userMessage",c),l(""),t(1)},$=()=>{if(i){M(!0);const c=new FormData;c.append("chatImageURL",i),G(c).then(g=>{const h={userId:I,roomId:d._id,message:{messageOwner:"user",messageType:"image",messageText:g.imageURL}};n({type:S,payload:h}),r.emit("userMessage",h)}).catch(()=>L.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{m(null),f(!1),w(null),M(!1)})}},O=c=>{const g=c.target.files[0];m(g),f(!0);const h=URL.createObjectURL(g);w(h)},H=()=>{C.current&&C.current.click()},B=()=>{s.trim()!==""&&t(o.current)},J=()=>{j(!x)};return e.jsx(e.Fragment,{children:A?e.jsx(Q,{}):e.jsxs("footer",{className:"absolute bottom-0 w-full",children:[e.jsxs("div",{className:"relative items-center bg-mainColors-staticWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:y,value:s,onChange:U,onFocus:B,onBlur:()=>t(1)}),!s&&!u&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:J,children:e.jsx(V,{colorFill:x?b.brand:b.primary})}),e.jsxs("button",{className:"icon-style",onClick:H,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:O,ref:C}),e.jsx(q,{})]})]}),s&&e.jsx("button",{type:"submit",className:"icon-style",onClick:_,children:e.jsx(F,{})}),u&&e.jsx("button",{type:"submit",className:"icon-style",onClick:$,children:e.jsx(F,{})}),p&&e.jsx("div",{className:"bg-mainColors-staticWhite ml-5 py-5",children:e.jsx("img",{src:p,alt:"Uploaded Image"})})]}),x&&e.jsxs("div",{className:"flex gap-3 py-xs justify-center fade-in",children:[e.jsx(Y,{disabled:!0,children:"Головне меню"}),e.jsx(Z,{to:"/",onClick:E,children:"Завершити діалог"})]})]})})},re=()=>{const n=k(),d=R(K),[x,j]=a.useState(!1),s=R(v),l=a.useRef(null),y=localStorage.getItem("userId");return a.useEffect(()=>{r.emit("authentication",{token:d}),j(!0)},[d]),r.on("authenticationError",({message:t})=>{L.error(t),j(!1)}),a.useEffect(()=>{s||n(P(y))},[s,n,y]),a.useEffect(()=>(r.on("userStatusChanged",({userId:t,isOnline:o})=>{n({type:X,payload:{userId:t,isOnline:o}})}),()=>{r.off("userStatusChanged")}),[n]),a.useEffect(()=>(r.on("managerJoinToChat",t=>{if(n({type:N,payload:t}),s){const{_id:o,managerName:i,managerSurname:m}=s,u={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${i} ${m}`,createdAt:Date.now()}};n({type:S,payload:u})}}),()=>{r.off("managerJoinToChat")}),[s,n]),a.useEffect(()=>(r.on("disconnectManager",t=>{const{_id:o,managerName:i,managerSurname:m}=s,u=t.findIndex(p=>p._id===o);n({type:N,payload:t[u]});const f={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${i} ${m} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};n({type:S,payload:f})}),()=>{r.off("disconnectManager")}),[s,n]),a.useEffect(()=>{if(l.current){const t=l.current.scrollHeight,o=l.current.clientHeight;t>o&&(l.current.scrollTop=t-o)}},[s]),x?e.jsxs("div",{children:[e.jsx(ee,{children:e.jsxs("section",{ref:l,className:"flex flex-col gap-5 py-5 message-container",children:[e.jsx(D,{type:"text",text:se,time:s==null?void 0:s.createdAt}),s&&(s==null?void 0:s.messages.map((t,o)=>{const{_id:i=o,messageOwner:m,messageText:u,messageType:f,createdAt:p=Date.now()}=t;return e.jsx(D,{owner:m==="user"?"Ви":`Менеджер ${s.managerName} ${s.managerSurname}`,type:f,text:u,time:p},i)}))]})}),e.jsx(te,{})]}):null};export{re as default};
