import{j as t,c as _,g as ge,P as R,a as Q,u as L,b as X,r as a,d as f,L as pe,M as xe,i as P,A as he,S as ye,e as N,f as je,Q as Z,h as be,k as Te,s as ve,l as Se,m as Ce,n as we,o as G,B as Ie,p as Me}from"./index-d2320310.js";import{S as Oe,D as Y,a as Ee,P as ke}from"./DestructiveBtn-868af247.js";import{C as $e,M as A,a as Fe}from"./Container-e68619bd.js";const Re=()=>t.jsxs("svg",{width:"60",height:"59",viewBox:"0 0 60 59",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("circle",{cx:"30.0002",cy:"29.5227",r:"29.3743",fill:"#FEF3F2"}),t.jsx("circle",{cx:"30.0005",cy:"29.5225",r:"20.0513",fill:"#FEE4E2"}),t.jsx("path",{d:"M30 26.6782V30.5366M30 34.395H30.0097M28.3506 21.7202L20.1804 35.3596C20.012 35.6513 19.9228 35.9821 19.9219 36.3189C19.9209 36.6558 20.0082 36.987 20.175 37.2797C20.3418 37.5723 20.5824 37.8162 20.8727 37.987C21.163 38.1579 21.493 38.2497 21.8299 38.2534H38.1702C38.507 38.2497 38.837 38.1579 39.1274 37.987C39.4177 37.8162 39.6582 37.5723 39.825 37.2797C39.9919 36.987 40.0791 36.6558 40.0782 36.3189C40.0773 35.9821 39.9881 35.6513 39.8197 35.3596L31.6495 21.7202C31.4775 21.4367 31.2354 21.2023 30.9465 21.0396C30.6576 20.877 30.3316 20.7915 30 20.7915C29.6685 20.7915 29.3425 20.877 29.0536 21.0396C28.7647 21.2023 28.5225 21.4367 28.3506 21.7202Z",stroke:"#F04438",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})]});function Ne(e){var s=typeof e;return e!=null&&(s=="object"||s=="function")}var ee=Ne,_e=typeof _=="object"&&_&&_.Object===Object&&_,Le=_e,De=Le,Be=typeof self=="object"&&self&&self.Object===Object&&self,Ae=De||Be||Function("return this")(),te=Ae,Ue=te,We=function(){return Ue.Date.now()},Pe=We,Ge=/\s/;function He(e){for(var s=e.length;s--&&Ge.test(e.charAt(s)););return s}var qe=He,Ke=qe,ze=/^\s+/;function Je(e){return e&&e.slice(0,Ke(e)+1).replace(ze,"")}var Ve=Je,Qe=te,Xe=Qe.Symbol,se=Xe,H=se,ne=Object.prototype,Ze=ne.hasOwnProperty,Ye=ne.toString,F=H?H.toStringTag:void 0;function et(e){var s=Ze.call(e,F),d=e[F];try{e[F]=void 0;var l=!0}catch{}var u=Ye.call(e);return l&&(s?e[F]=d:delete e[F]),u}var tt=et,st=Object.prototype,nt=st.toString;function at(e){return nt.call(e)}var rt=at,q=se,ot=tt,it=rt,ct="[object Null]",lt="[object Undefined]",K=q?q.toStringTag:void 0;function ut(e){return e==null?e===void 0?lt:ct:K&&K in Object(e)?ot(e):it(e)}var dt=ut;function ft(e){return e!=null&&typeof e=="object"}var mt=ft,gt=dt,pt=mt,xt="[object Symbol]";function ht(e){return typeof e=="symbol"||pt(e)&&gt(e)==xt}var yt=ht,jt=Ve,z=ee,bt=yt,J=0/0,Tt=/^[-+]0x[0-9a-f]+$/i,vt=/^0b[01]+$/i,St=/^0o[0-7]+$/i,Ct=parseInt;function wt(e){if(typeof e=="number")return e;if(bt(e))return J;if(z(e)){var s=typeof e.valueOf=="function"?e.valueOf():e;e=z(s)?s+"":s}if(typeof e!="string")return e===0?e:+e;e=jt(e);var d=vt.test(e);return d||St.test(e)?Ct(e.slice(2),d?2:8):Tt.test(e)?J:+e}var It=wt,Mt=ee,U=Pe,V=It,Ot="Expected a function",Et=Math.max,kt=Math.min;function $t(e,s,d){var l,u,T,x,i,j,v=0,o=!1,h=!1,b=!0;if(typeof e!="function")throw new TypeError(Ot);s=V(s)||0,Mt(d)&&(o=!!d.leading,h="maxWait"in d,T=h?Et(V(d.maxWait)||0,s):T,b="trailing"in d?!!d.trailing:b);function C(n){var m=l,S=u;return l=u=void 0,v=n,x=e.apply(S,m),x}function y(n){return v=n,i=setTimeout(w,s),o?C(n):x}function M(n){var m=n-j,S=n-v,O=s-m;return h?kt(O,T-S):O}function I(n){var m=n-j,S=n-v;return j===void 0||m>=s||m<0||h&&S>=T}function w(){var n=U();if(I(n))return k(n);i=setTimeout(w,M(n))}function k(n){return i=void 0,b&&l?C(n):(l=u=void 0,x)}function r(){i!==void 0&&clearTimeout(i),v=0,l=j=u=i=void 0}function c(){return i===void 0?x:k(U())}function p(){var n=U(),m=I(n);if(l=arguments,u=this,j=n,m){if(i===void 0)return y(j);if(h)return clearTimeout(i),i=setTimeout(w,s),C(j)}return i===void 0&&(i=setTimeout(w,s)),x}return p.cancel=r,p.flush=c,p}var Ft=$t;const Rt=ge(Ft);const ae=({isActiveMenu:e,isOpenModal:s,onFinishChat:d})=>{const l=Q(),u=L(X),[T,x]=a.useState(!1),[i,j]=a.useState(""),[v,o]=a.useState(1),h=a.useRef(v),[b,C]=a.useState(null),[y,M]=a.useState(!1),[I,w]=a.useState(null),[k,r]=a.useState(!1),c=a.useRef(null),[p,n]=a.useState(!1),m=localStorage.getItem("userId");let S;const O=Rt(g=>{f.emit("userTyping",{isTyping:g,roomId:u._id})},1e3),oe=g=>{const E=g.target,$=1,me=4;j(E.value);const W=Math.min(me,Math.max($,E.scrollHeight/24));o(W),h.current=W,O(!0),clearTimeout(S),S=setTimeout(()=>{O(!1)},2e3)},D=()=>{if(i.trim()==="")return;const g={userId:m,roomId:u._id,message:{messageOwner:"user",messageType:"text",messageText:i}};l({type:N,payload:g}),f.emit("userMessage",g),j(""),o(1)},B=()=>{if(b){n(!0),r(!0);const g=new FormData;g.append("chatImageURL",b),je(g).then(E=>{const $={userId:m,roomId:u._id,message:{messageOwner:"user",messageType:"image",messageText:E.imageURL}};l({type:N,payload:$}),f.emit("userMessage",$)}).catch(()=>Z.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{C(null),M(!1),w(null),n(!1),r(!1)})}},ie=g=>{const E=g.target.files[0];C(E),M(!0);const $=URL.createObjectURL(E);w($)},ce=()=>{c.current&&c.current.click()},le=()=>{i.trim()!==""&&o(h.current)},ue=g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),k?B():D())},de=()=>{x(!T)},fe=()=>{o(1),O(!1),clearTimeout(S)};return a.useEffect(()=>{x(e)},[e]),t.jsx(t.Fragment,{children:p?t.jsx(pe,{}):t.jsxs("footer",{className:"absolute bottom-0 w-full",children:[t.jsxs("div",{className:"relative items-center bg-mainColors-staticWhite",children:[t.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:v,value:i,onChange:oe,onKeyDown:ue,onFocus:le,onBlur:fe}),!i&&!y&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:de,children:t.jsx(xe,{colorFill:T?P.brand:P.primary})}),t.jsxs("button",{className:"icon-style",onClick:ce,children:[t.jsx("input",{type:"file",style:{display:"none"},onChange:ie,ref:c}),t.jsx(he,{})]})]}),(y||i)&&t.jsx("button",{type:"submit",className:"icon-style",onClick:i&&y?()=>{D(),B()}:i?D:B,children:t.jsx(ye,{})}),I&&t.jsx("div",{className:"bg-mainColors-staticWhite ml-5 py-5",children:t.jsx("img",{src:I,alt:"Uploaded Image"})})]}),T&&t.jsxs("div",{className:"flex gap-3 py-xs justify-center fade-in",children:[t.jsx(Oe,{to:"/",disabled:u==null?void 0:u.isChatRoomProcessed,onClick:()=>d(),children:"Головне меню"}),t.jsx(Y,{onClick:()=>s(),children:"Завершити діалог"})]})]})})};ae.propTypes={isActiveMenu:R.bool.isRequired,isOpenModal:R.func.isRequired,onFinishChat:R.func};const Nt=document.getElementById("modal-root"),re=({onFinishChat:e,closeModal:s})=>{a.useEffect(()=>{const l=u=>{u.code==="Escape"&&s()};return window.addEventListener("keydown",l),()=>{window.removeEventListener("keydown",l)}},[s]);const d=l=>{l.target===l.currentTarget&&s()};return be.createPortal(t.jsx("div",{onMouseDown:d,className:"fixed z-40 top-[0] left-[0] w-[100vw] h-[100vh] bg-bgColors-backDrop",children:t.jsxs("div",{className:`absolute z-30 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2\r
                   flex flex-col gap-m2 py-m px-s w-[400px] h-auto items-center justify-center\r
                 bg-bgColors-white rounded-medium`,children:[t.jsxs("div",{className:"flex flex-col gap-xs items-center justify-center",children:[t.jsx(Re,{}),t.jsxs("div",{className:"flex flex-col gap-xs2 items-center justify-center leading-6 tracking-textBase",children:[t.jsx("h4",{className:"font-medium text-xl text-textColors-primary",children:"Завершити чат з оператором?"}),t.jsx("p",{className:"font-normal text-base text-textColors-secondary text-center",children:"Ви впевнені, що хочете завершити діалог з оператором?"})]})]}),t.jsxs("div",{className:"flex gap-xs justify-between",children:[t.jsx(Ee,{onClick:s,children:"Скасувати"}),t.jsx(Y,{to:"/",onClick:()=>e(),children:"Так, завершити"})]})]})}),Nt)};re.propTypes={onFinishChat:R.func.isRequired,closeModal:R.func.isRequired};const Bt=()=>{const e=Q(),[s,d]=a.useState(!1),[l,u]=a.useState(!1),[T,x]=a.useState(!1),[i,j]=a.useState(!0),v=L(Te),o=L(X),h=L(ve),b=a.useRef(null),C=localStorage.getItem("userId"),{_id:y,managerName:M,managerSurname:I}=o;a.useEffect(()=>{f.emit("authentication",{token:v}),d(!0)},[v]),f.on("authenticationError",({message:r})=>{Z.error(r),d(!1)}),a.useEffect(()=>(f.on("closeChatByManager",({room:r})=>{e({type:Se,payload:{room:r}})}),()=>{f.off("closeChatByManager")}),[e]),a.useEffect(()=>{!o&&h.isOnline===!0&&e(Ce(C))},[o,e,h.isOnline,C]),a.useEffect(()=>(f.on("managerMessage",({roomId:r,message:c})=>{e({type:N,payload:{roomId:r,message:c}})}),()=>{f.off("managerMessage")}),[e]),a.useEffect(()=>(f.on("managerTyping",({isTyping:r,roomId:c})=>{u(!!(r&&y&&c===y))}),()=>{f.off("managerTyping")}),[y]),a.useEffect(()=>(f.on("userStatusChanged",({userId:r,isOnline:c})=>{e({type:we,payload:{userId:r,isOnline:c}})}),()=>{f.off("userStatusChanged")}),[e]),a.useEffect(()=>(f.on("managerJoinToChat",r=>{e({type:G,payload:r});const{_id:c,managerName:p,managerSurname:n}=r;if(p){const m={roomId:c,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${p} ${n}`,createdAt:Date.now()}};e({type:N,payload:m})}}),()=>{f.off("managerJoinToChat")}),[e]),a.useEffect(()=>(f.on("disconnectManager",r=>{if(o){const c=r.findIndex(p=>p._id===y);if(c!==-1){e({type:G,payload:r[c]});const p={roomId:y,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${M} ${I} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};e({type:N,payload:p})}}}),()=>{f.off("disconnectManager")}),[y,o,e,M,I]),a.useEffect(()=>{if(b.current){const r=b.current.scrollHeight,c=b.current.clientHeight;r>c&&(b.current.scrollTop=r-c)}},[o,l]);const w=()=>{o&&(e(Me({chatRoomId:y,userId:C,username:h.username,userSurname:h.userSurname})),j(!1),x(!1))},k=()=>x(!0);return s?t.jsxs("div",{children:[t.jsxs($e,{children:[t.jsxs("section",{ref:b,className:"flex flex-col gap-5 py-5 message-container",children:[o&&t.jsx(A,{type:"text",text:Fe,time:o==null?void 0:o.createdAt}),o&&(o==null?void 0:o.messages.map((r,c)=>{const{_id:p=c,messageOwner:n,messageText:m,messageType:S,createdAt:O}=r;return t.jsx(A,{owner:n==="user"?"Ви":n==="Бот"?"Бот":`Менеджер ${M} ${I}`,type:S,text:m,time:O},p)})),l&&t.jsx("div",{children:t.jsx(ke,{disabled:!0,children:t.jsxs("div",{className:"flex gap-xs2",children:[t.jsx("div",{className:"font-normal text-sm leading-5 text-textColors-tertiary",children:"Менеджер друкує повідомлення"}),t.jsx(Ie,{height:20,width:48,radius:8})]})})}),!o&&t.jsx(A,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]}),T&&t.jsx(re,{onFinishChat:w,closeModal:()=>x(!1)})]}),t.jsx(ae,{isActiveMenu:i,isOpenModal:k,onFinishChat:w})]}):null};export{Bt as default};
