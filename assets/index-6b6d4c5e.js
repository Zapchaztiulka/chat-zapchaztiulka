import{j as e,P as F,a as q,u as R,b as z,r as t,c as i,L as oe,M as re,A as ie,S as ce,d as E,e as le,Q as P,f as de,g as ue,h as me,s as ge,i as fe,k as xe,l as pe,m as W,B as he,n as ye}from"./index-3a23c706.js";import{B as k}from"./Button-b30a8316.js";import{C as be,M as _,a as we}from"./Container-ffb2fef9.js";const je=()=>e.jsxs("svg",{width:"60",height:"59",viewBox:"0 0 60 59",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("circle",{cx:"30.0002",cy:"29.5227",r:"29.3743",fill:"#FEF3F2"}),e.jsx("circle",{cx:"30.0005",cy:"29.5225",r:"20.0513",fill:"#FEE4E2"}),e.jsx("path",{d:"M30 26.6782V30.5366M30 34.395H30.0097M28.3506 21.7202L20.1804 35.3596C20.012 35.6513 19.9228 35.9821 19.9219 36.3189C19.9209 36.6558 20.0082 36.987 20.175 37.2797C20.3418 37.5723 20.5824 37.8162 20.8727 37.987C21.163 38.1579 21.493 38.2497 21.8299 38.2534H38.1702C38.507 38.2497 38.837 38.1579 39.1274 37.987C39.4177 37.8162 39.6582 37.5723 39.825 37.2797C39.9919 36.987 40.0791 36.6558 40.0782 36.3189C40.0773 35.9821 39.9881 35.6513 39.8197 35.3596L31.6495 21.7202C31.4775 21.4367 31.2354 21.2023 30.9465 21.0396C30.6576 20.877 30.3316 20.7915 30 20.7915C29.6685 20.7915 29.3425 20.877 29.0536 21.0396C28.7647 21.2023 28.5225 21.4367 28.3506 21.7202Z",stroke:"#F04438",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})]}),Ce=(o,u,x,d)=>new Promise(c=>{const p=new FileReader;p.readAsDataURL(o),p.onload=D=>{const a=new Image;a.src=D.target.result,a.onload=()=>{const h=document.createElement("canvas"),S=h.getContext("2d");let m=a.width,s=a.height;a.width>u&&(m=u,s=a.height*u/a.width),a.height>x&&(s=x,m=a.width*x/a.height),h.width=m,h.height=s,S.drawImage(a,0,0,m,s);const y=h.toDataURL("image/jpeg",d);c(y)}}});const G=({isActiveMenu:o,isOpenModal:u,onFinishChat:x})=>{const d=q(),c=R(z),[p,D]=t.useState(!1),[a,h]=t.useState(""),[S,m]=t.useState(1),s=t.useRef(S),[y,b]=t.useState(null),[C,I]=t.useState(!1),[N,n]=t.useState(null),[r,g]=t.useState(!1),f=t.useRef(null),[w,j]=t.useState(!1),[L,A]=t.useState(!1),[B,J]=t.useState(null),U=localStorage.getItem("userId");let V;const M=t.useCallback(l=>{i.emit("userTyping",{isTyping:l,roomId:c._id}),A(l)},[c==null?void 0:c._id]),Q=l=>{const v=l.target,T=1,ae=4;h(v.value);const $=Math.min(ae,Math.max(T,v.scrollHeight/24));m($),s.current=$,L||M(!0),clearTimeout(B);const ne=setTimeout(()=>{M(!1)},3e3);J(ne)},O=()=>{if(a.trim()==="")return;const l={userId:U,roomId:c._id,message:{messageOwner:"user",messageType:"text",messageText:a}};d({type:E,payload:l}),i.emit("userMessage",l),M(!1),h(""),m(1)},H=()=>{if(y){j(!0),g(!0);const l=new FormData;l.append("chatImageURL",y),le(l).then(v=>{const T={userId:U,roomId:c._id,message:{messageOwner:"user",messageType:"image",messageText:v.imageURL}};d({type:E,payload:T}),i.emit("userMessage",T),M(!1)}).catch(()=>P.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{b(null),I(!1),n(null),j(!1),g(!1)})}},Z=async l=>{const v=l.target.files[0];b(v),I(!0);try{const T=await Ce(v,200,200,.8);n(T)}catch{P.error("Помилка завантаження фото. Будь-ласка повторіть спробу")}},X=()=>{f.current&&f.current.click()},Y=()=>{a.trim()!==""&&m(s.current)},ee=l=>{l.key==="Enter"&&!l.shiftKey&&(l.preventDefault(),r?H():O())},te=()=>{D(!p)},se=()=>{m(1),M(!1),clearTimeout(V)};return t.useEffect(()=>{D(o)},[o]),e.jsx(e.Fragment,{children:w?e.jsx(oe,{}):e.jsxs("footer",{className:"absolute bottom-[0] w-full",children:[e.jsxs("div",{className:"relative items-center bg-bgWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:S,value:a,onChange:Q,onKeyDown:ee,onFocus:Y,onBlur:se}),!a&&!C&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:te,children:e.jsx(re,{activeMenu:p})}),e.jsxs("button",{className:"icon-style",onClick:X,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:Z,ref:f}),e.jsx(ie,{})]})]}),(C||a)&&e.jsx("button",{type:"submit",className:"icon-style",onClick:a&&C?()=>{O(),H()}:a?O:H,children:e.jsx(ce,{})}),N&&e.jsx("div",{className:"bg-bgWhite ml-sPlus py-sPlus",children:e.jsx("img",{src:N,alt:"Uploaded Image"})})]}),p&&e.jsxs("div",{className:"flex gap-xs py-xs justify-center fade-in",children:[e.jsx(k,{buttonType:"secondary",text:"Головне меню",className:`font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors 
                duration-300 focus:outline-none min-w-[150px] h-[48px] bg-bgWhite text-textBrand border-solid border-1
                 border-borderDefaultBlue py-xs px-m leading-6 hover:bg-bgHoverGrey focus:shadow-btFocus
                 ${(c==null?void 0:c.isChatRoomProcessed)&&"text-textDisabled border-borderDisabled bg-bgDisable cursor-not-allowed pointer-events-none"}`,onClick:()=>x()}),e.jsx(k,{buttonType:"desctructive",className:`font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors \r
                duration-300 focus:outline-none min-w-[150px] h-[48px] text-textContrast bg-bgDefaultDestructive py-xs\r
                px-m leading-6 hover:bg-bgHoverDestructive focus:bg-bgDefaultDestructive focus:shadow-btFocus`,text:"Завершити діалог",onClick:()=>u()})]})]})})};G.propTypes={isActiveMenu:F.bool.isRequired,isOpenModal:F.func.isRequired,onFinishChat:F.func};const ve=document.getElementById("modal-root"),K=({onFinishChat:o,closeModal:u})=>{t.useEffect(()=>{const d=c=>{c.code==="Escape"&&u()};return window.addEventListener("keydown",d),()=>{window.removeEventListener("keydown",d)}},[u]);const x=d=>{d.target===d.currentTarget&&u()};return de.createPortal(e.jsx("div",{onMouseDown:x,className:"fixed z-40 top-[0] left-[0] w-[100vw] h-[100vh] bg-aditional1",children:e.jsxs("div",{className:`absolute z-30 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2\r
                   flex flex-col gap-m2 py-m px-s w-[400px] h-auto items-center justify-center\r
                 bg-bgWhite rounded-medium`,children:[e.jsxs("div",{className:"flex flex-col gap-xs items-center justify-center",children:[e.jsx(je,{}),e.jsxs("div",{className:"flex flex-col gap-xs2 items-center justify-center",children:[e.jsx("h4",{className:"font-500 text-heading4 text-textPrimary",children:"Завершити чат з оператором?"}),e.jsx("p",{className:"font-400 text-body text-textSecondary text-center",children:"Ви впевнені, що хочете завершити діалог з оператором?"})]})]}),e.jsxs("div",{className:"flex gap-xs justify-between",children:[e.jsx(k,{buttonType:"secondary-gray",className:"font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors duration-300  focus:outline-none min-w-[150px] bg-bgWhite text-textPrimary border-solid border-1 border-borderDefault py-xs px-m leading-6 hover:bg-bgHoverGrey focus:shadow-btFocus  active:bg-bgPressedGrey active:border-borderDefault h-[48px]",text:"Скасувати",onClick:u}),e.jsx(k,{buttonType:"desctructive",className:"font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors duration-300 focus:outline-none min-w-[150px] text-textContrast bg-bgDefaultDestructive py-xs px-m leading-6 hover:bg-bgHoverDestructive focus:bg-bgDefaultDestructive focus:shadow-btFocus disabled:border-solid  disabled:border-1 disabled:border-borderDisabled active:bg-bgPressedDestructive h-[48px]",text:"Так, завершити",onClick:()=>o()})]})]})}),ve)};K.propTypes={onFinishChat:F.func.isRequired,closeModal:F.func.isRequired};const Me=()=>{const o=q(),u=ue(),[x,d]=t.useState(!1),[c,p]=t.useState(!1),[D,a]=t.useState(!1),[h,S]=t.useState(!0),m=R(me),s=R(z),y=R(ge),b=t.useRef(null),C=localStorage.getItem("userId");t.useEffect(()=>{i.emit("authentication",{token:m}),d(!0)},[m]),i.on("authenticationError",({message:n})=>{P.error(n),d(!1)}),t.useEffect(()=>(i.on("closeChatByManager",({room:n})=>{o({type:fe,payload:{room:n}})}),()=>{i.off("closeChatByManager")}),[o]),t.useEffect(()=>{!s&&y.isOnline===!0&&o(xe(C))},[s,o,y.isOnline,C]),t.useEffect(()=>(i.on("managerMessage",({roomId:n,message:r})=>{o({type:E,payload:{roomId:n,message:r}})}),()=>{i.off("managerMessage")}),[o]),t.useEffect(()=>(i.on("managerTyping",({isTyping:n,roomId:r})=>{const{_id:g}=s;p(!!(n&&g&&r===g))}),()=>{i.off("managerTyping")}),[s]),t.useEffect(()=>(i.on("userStatusChanged",({userId:n,isOnline:r})=>{o({type:pe,payload:{userId:n,isOnline:r}})}),()=>{i.off("userStatusChanged")}),[o]),t.useEffect(()=>(i.on("managerJoinToChat",n=>{o({type:W,payload:n});const{_id:r,managerName:g,managerSurname:f}=n;if(g){const w={roomId:r,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${g} ${f}`,createdAt:Date.now()}};o({type:E,payload:w})}}),()=>{i.off("managerJoinToChat")}),[o]),t.useEffect(()=>(i.on("disconnectManager",n=>{const{_id:r,managerName:g,managerSurname:f}=s;if(s){const w=n.findIndex(j=>j._id===r);if(w!==-1){o({type:W,payload:n[w]});const j={roomId:r,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${g} ${f} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};o({type:E,payload:j})}}}),()=>{i.off("disconnectManager")}),[s,o]),t.useEffect(()=>{if(b.current){const n=b.current.scrollHeight,r=b.current.clientHeight;n>r&&(b.current.scrollTop=n-r)}},[s,c]);const I=()=>{s&&(o(ye({chatRoomId:s._id,userId:C,username:y.username,userSurname:y.userSurname})),S(!1),a(!1),u("/"))},N=()=>a(!0);return x?e.jsxs("div",{children:[e.jsxs(be,{children:[e.jsxs("section",{ref:b,className:"flex flex-col gap-sPlus py-sPlus message-container",children:[s&&e.jsx(_,{type:"text",text:we,time:s==null?void 0:s.createdAt}),s&&(s==null?void 0:s.messages.map((n,r)=>{const{_id:g=r,messageOwner:f,messageText:w,messageType:j,createdAt:L}=n,{managerName:A,managerSurname:B}=s;return e.jsx(_,{owner:f==="user"?"Ви":f==="Бот"?"Бот":`Менеджер ${A} ${B}`,type:j,text:w,time:L},g)})),c&&e.jsxs("div",{className:"flex gap-xs2",children:[e.jsx("div",{className:"font-400 text-caption text-textTertiary",children:"Менеджер друкує повідомлення"}),e.jsx(he,{height:20,width:48,radius:8})]}),!s&&e.jsx(_,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]}),D&&e.jsx(K,{onFinishChat:I,closeModal:()=>a(!1)})]}),e.jsx(G,{isActiveMenu:h,isOpenModal:N,onFinishChat:I})]}):null};export{Me as default};
