import{j as e,P as v,a as W,u as R,b as q,r as t,c as r,L as oe,M as re,A as ce,S as ie,d as b,e as le,Q as K,f as ue,g as de,h as me,s as fe,i as ge,k as xe,l as pe,m as P,B as he,n as ye}from"./index-cc23266c.js";import{B as L}from"./Button-30a346f5.js";import{C as je,M as U,a as Ce}from"./Container-eb1a1442.js";const Te=()=>e.jsxs("svg",{width:"60",height:"59",viewBox:"0 0 60 59",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("circle",{cx:"30.0002",cy:"29.5227",r:"29.3743",fill:"#FEF3F2"}),e.jsx("circle",{cx:"30.0005",cy:"29.5225",r:"20.0513",fill:"#FEE4E2"}),e.jsx("path",{d:"M30 26.6782V30.5366M30 34.395H30.0097M28.3506 21.7202L20.1804 35.3596C20.012 35.6513 19.9228 35.9821 19.9219 36.3189C19.9209 36.6558 20.0082 36.987 20.175 37.2797C20.3418 37.5723 20.5824 37.8162 20.8727 37.987C21.163 38.1579 21.493 38.2497 21.8299 38.2534H38.1702C38.507 38.2497 38.837 38.1579 39.1274 37.987C39.4177 37.8162 39.6582 37.5723 39.825 37.2797C39.9919 36.987 40.0791 36.6558 40.0782 36.3189C40.0773 35.9821 39.9881 35.6513 39.8197 35.3596L31.6495 21.7202C31.4775 21.4367 31.2354 21.2023 30.9465 21.0396C30.6576 20.877 30.3316 20.7915 30 20.7915C29.6685 20.7915 29.3425 20.877 29.0536 21.0396C28.7647 21.2023 28.5225 21.4367 28.3506 21.7202Z",stroke:"#F04438",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})]});const z=({isActiveMenu:n,isOpenModal:f,onFinishChat:S})=>{const d=W(),i=R(q),[T,E]=t.useState(!1),[l,F]=t.useState(""),[k,h]=t.useState(1),s=t.useRef(k),[y,g]=t.useState(null),[j,M]=t.useState(!1),[N,a]=t.useState(null),[o,u]=t.useState(!1),m=t.useRef(null),[x,p]=t.useState(!1),[D,O]=t.useState(!1),[A,V]=t.useState(null),H=localStorage.getItem("userId");let Q;const I=t.useCallback(c=>{r.emit("userTyping",{isTyping:c,roomId:i._id}),O(c)},[i==null?void 0:i._id]),Z=c=>{const C=c.target,w=1,ae=4;F(C.value);const $=Math.min(ae,Math.max(w,C.scrollHeight/24));h($),s.current=$,D||I(!0),clearTimeout(A);const ne=setTimeout(()=>{I(!1)},3e3);V(ne)},B=()=>{if(l.trim()==="")return;const c={userId:H,roomId:i._id,message:{messageOwner:"user",messageType:"text",messageText:l}};d({type:b,payload:c}),r.emit("userMessage",c),I(!1),F(""),h(1)},_=()=>{if(y){p(!0),u(!0);const c=new FormData;c.append("chatImageURL",y),le(c).then(C=>{const w={userId:H,roomId:i._id,message:{messageOwner:"user",messageType:"image",messageText:C.imageURL}};d({type:b,payload:w}),r.emit("userMessage",w),I(!1)}).catch(()=>K.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{g(null),M(!1),a(null),p(!1),u(!1)})}},G=c=>{const C=c.target.files[0];g(C),M(!0);const w=URL.createObjectURL(C);a(w)},X=()=>{m.current&&m.current.click()},Y=()=>{l.trim()!==""&&h(s.current)},ee=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),o?_():B())},te=()=>{E(!T)},se=()=>{h(1),I(!1),clearTimeout(Q)};return t.useEffect(()=>{E(n)},[n]),e.jsx(e.Fragment,{children:x?e.jsx(oe,{}):e.jsxs("footer",{className:"absolute bottom-[0] w-full",children:[e.jsxs("div",{className:"relative items-center bg-bgWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:k,value:l,onChange:Z,onKeyDown:ee,onFocus:Y,onBlur:se}),!l&&!j&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:te,children:e.jsx(re,{activeMenu:T})}),e.jsxs("button",{className:"icon-style",onClick:X,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:G,ref:m}),e.jsx(ce,{})]})]}),(j||l)&&e.jsx("button",{type:"submit",className:"icon-style",onClick:l&&j?()=>{B(),_()}:l?B:_,children:e.jsx(ie,{})}),N&&e.jsx("div",{className:"bg-bgWhite ml-sPlus py-sPlus",children:e.jsx("img",{src:N,alt:"Uploaded Image"})})]}),T&&e.jsxs("div",{className:"flex gap-xs py-xs justify-center fade-in",children:[e.jsx(L,{buttonType:"secondary",text:"Головне меню",disabled:i==null?void 0:i.isChatRoomProcessed,onClick:()=>S()}),e.jsx(L,{buttonType:"desctructive",text:"Завершити діалог",onClick:()=>f()})]})]})})};z.propTypes={isActiveMenu:v.bool.isRequired,isOpenModal:v.func.isRequired,onFinishChat:v.func};const we=document.getElementById("modal-root"),J=({onFinishChat:n,closeModal:f})=>{t.useEffect(()=>{const d=i=>{i.code==="Escape"&&f()};return window.addEventListener("keydown",d),()=>{window.removeEventListener("keydown",d)}},[f]);const S=d=>{d.target===d.currentTarget&&f()};return ue.createPortal(e.jsx("div",{onMouseDown:S,className:"fixed z-40 top-[0] left-[0] w-[100vw] h-[100vh] bg-aditional1",children:e.jsxs("div",{className:`absolute z-30 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2\r
                   flex flex-col gap-m2 py-m px-s w-[400px] h-auto items-center justify-center\r
                 bg-bgWhite rounded-medium`,children:[e.jsxs("div",{className:"flex flex-col gap-xs items-center justify-center",children:[e.jsx(Te,{}),e.jsxs("div",{className:"flex flex-col gap-xs2 items-center justify-center",children:[e.jsx("h4",{className:"font-500 text-heading4 text-textPrimary",children:"Завершити чат з оператором?"}),e.jsx("p",{className:"font-400 text-body text-textSecondary text-center",children:"Ви впевнені, що хочете завершити діалог з оператором?"})]})]}),e.jsxs("div",{className:"flex gap-xs justify-between",children:[e.jsx(L,{buttonType:"secondary-gray",text:"Скасувати",onClick:f}),e.jsx(L,{buttonType:"desctructive",text:"Так, завершити",onClick:()=>n()})]})]})}),we)};J.propTypes={onFinishChat:v.func.isRequired,closeModal:v.func.isRequired};const be=()=>{const n=W(),f=de(),[S,d]=t.useState(!1),[i,T]=t.useState(!1),[E,l]=t.useState(!1),[F,k]=t.useState(!0),h=R(me),s=R(q),y=R(fe),g=t.useRef(null),j=localStorage.getItem("userId");t.useEffect(()=>{r.emit("authentication",{token:h}),d(!0)},[h]),r.on("authenticationError",({message:a})=>{K.error(a),d(!1)}),t.useEffect(()=>(r.on("closeChatByManager",({room:a})=>{n({type:ge,payload:{room:a}})}),()=>{r.off("closeChatByManager")}),[n]),t.useEffect(()=>{!s&&y.isOnline===!0&&n(xe(j))},[s,n,y.isOnline,j]),t.useEffect(()=>(r.on("managerMessage",({roomId:a,message:o})=>{n({type:b,payload:{roomId:a,message:o}})}),()=>{r.off("managerMessage")}),[n]),t.useEffect(()=>(r.on("managerTyping",({isTyping:a,roomId:o})=>{const{_id:u}=s;T(!!(a&&u&&o===u))}),()=>{r.off("managerTyping")}),[s]),t.useEffect(()=>(r.on("userStatusChanged",({userId:a,isOnline:o})=>{n({type:pe,payload:{userId:a,isOnline:o}})}),()=>{r.off("userStatusChanged")}),[n]),t.useEffect(()=>(r.on("managerJoinToChat",a=>{n({type:P,payload:a});const{_id:o,managerName:u,managerSurname:m}=a;if(u){const x={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${u} ${m}`,createdAt:Date.now()}};n({type:b,payload:x})}}),()=>{r.off("managerJoinToChat")}),[n]),t.useEffect(()=>(r.on("disconnectManager",a=>{const{_id:o,managerName:u,managerSurname:m}=s;if(s){const x=a.findIndex(p=>p._id===o);if(x!==-1){n({type:P,payload:a[x]});const p={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${u} ${m} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};n({type:b,payload:p})}}}),()=>{r.off("disconnectManager")}),[s,n]),t.useEffect(()=>{if(g.current){const a=g.current.scrollHeight,o=g.current.clientHeight;a>o&&(g.current.scrollTop=a-o)}},[s,i]);const M=()=>{s&&(n(ye({chatRoomId:s._id,userId:j,username:y.username,userSurname:y.userSurname})),k(!1),l(!1),f("/"))},N=()=>l(!0);return S?e.jsxs("div",{children:[e.jsxs(je,{children:[e.jsxs("section",{ref:g,className:"flex flex-col gap-sPlus py-sPlus message-container",children:[s&&e.jsx(U,{type:"text",text:Ce,time:s==null?void 0:s.createdAt}),s&&(s==null?void 0:s.messages.map((a,o)=>{const{_id:u=o,messageOwner:m,messageText:x,messageType:p,createdAt:D}=a,{managerName:O,managerSurname:A}=s;return e.jsx(U,{owner:m==="user"?"Ви":m==="Бот"?"Бот":`Менеджер ${O} ${A}`,type:p,text:x,time:D},u)})),i&&e.jsxs("div",{className:"flex gap-xs2",children:[e.jsx("div",{className:"font-400 text-caption text-textTertiary",children:"Менеджер друкує повідомлення"}),e.jsx(he,{height:20,width:48,radius:8})]}),!s&&e.jsx(U,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]}),E&&e.jsx(J,{onFinishChat:M,closeModal:()=>l(!1)})]}),e.jsx(z,{isActiveMenu:F,isOpenModal:N,onFinishChat:M})]}):null};export{be as default};
