import{P as z,a as A,u as I,b as U,r as a,j as e,L as G,M as X,i as N,A as Y,S as v,c as Z,d as S,e as r,f as ee,Q as O,g as se,s as te,h as ae,k as ne,l as oe,m as L}from"./index-423c2495.js";import{S as re,D as ce}from"./SearchBtnMini-69b7d755.js";import{C as le,M as R,a as ie}from"./Container-4683afb9.js";const _=({isActiveMenu:n})=>{const f=A(),i=I(U),[p,s]=a.useState(!1),[l,C]=a.useState(""),[j,t]=a.useState(1),o=a.useRef(j),[u,m]=a.useState(null),[d,h]=a.useState(!1),[y,T]=a.useState(null),[$,b]=a.useState(!1),M=a.useRef(null),[B,D]=a.useState(!1),w=localStorage.getItem("userId"),H=()=>{i&&(f(Z({chatRoomId:i._id,userId:w})),s(!1))},K=c=>{const g=c.target,x=1,V=4;C(g.value);const E=Math.min(V,Math.max(x,g.scrollHeight/24));t(E),o.current=E},F=()=>{if(l.trim()==="")return;const c={userId:w,roomId:i._id,message:{messageOwner:"user",messageType:"text",messageText:l}};f({type:S,payload:c}),r.emit("userMessage",c),C(""),t(1)},k=()=>{if(u){D(!0),b(!0);const c=new FormData;c.append("chatImageURL",u),ee(c).then(g=>{const x={userId:w,roomId:i._id,message:{messageOwner:"user",messageType:"image",messageText:g.imageURL}};f({type:S,payload:x}),r.emit("userMessage",x)}).catch(()=>O.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{m(null),h(!1),T(null),D(!1),b(!1)})}},J=c=>{const g=c.target.files[0];m(g),h(!0);const x=URL.createObjectURL(g);T(x)},W=()=>{M.current&&M.current.click()},q=()=>{l.trim()!==""&&t(o.current)},P=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),$?k():F())},Q=()=>{s(!p)};return a.useEffect(()=>{s(n)},[n]),e.jsx(e.Fragment,{children:B?e.jsx(G,{}):e.jsxs("footer",{className:"absolute bottom-0 w-full",children:[e.jsxs("div",{className:"relative items-center bg-mainColors-staticWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:j,value:l,onChange:K,onKeyDown:P,onFocus:q,onBlur:()=>t(1)}),!l&&!d&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:Q,children:e.jsx(X,{colorFill:p?N.brand:N.primary})}),e.jsxs("button",{className:"icon-style",onClick:W,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:J,ref:M}),e.jsx(Y,{})]})]}),l&&e.jsx("button",{type:"submit",className:"icon-style",onClick:F,children:e.jsx(v,{})}),d&&e.jsx("button",{type:"submit",className:"icon-style",onClick:k,children:e.jsx(v,{})}),y&&e.jsx("div",{className:"bg-mainColors-staticWhite ml-5 py-5",children:e.jsx("img",{src:y,alt:"Uploaded Image"})})]}),p&&e.jsxs("div",{className:"flex gap-3 py-xs justify-center fade-in",children:[e.jsx(re,{to:"/",disabled:i==null?void 0:i.isChatRoomProcessed,onClick:()=>s(!1),children:"Головне меню"}),e.jsx(ce,{to:"/",onClick:H,children:"Завершити діалог"})]})]})})};_.propTypes={isActiveMenu:z.bool.isRequired};const ge=()=>{const n=A(),f=I(se),[i,p]=a.useState(!1),s=I(U),l=a.useRef(null),C=localStorage.getItem("userId"),j=I(te);return a.useEffect(()=>{r.emit("authentication",{token:f}),p(!0)},[f]),r.on("authenticationError",({message:t})=>{O.error(t),p(!1)}),a.useEffect(()=>(r.on("closeChatByManager",({room:t})=>{n({type:ae,payload:{room:t}})}),()=>{r.off("closeChatByManager")}),[n]),a.useEffect(()=>{!s&&j.isOnline===!0&&n(ne(C))},[s,n,j.isOnline,C]),a.useEffect(()=>(r.on("managerMessage",({roomId:t,message:o})=>{n({type:S,payload:{roomId:t,message:o}})}),()=>{r.off("managerMessage")}),[n]),a.useEffect(()=>(r.on("userStatusChanged",({userId:t,isOnline:o})=>{n({type:oe,payload:{userId:t,isOnline:o}})}),()=>{r.off("userStatusChanged")}),[n]),a.useEffect(()=>(r.on("managerJoinToChat",t=>{n({type:L,payload:t});const{_id:o,managerName:u,managerSurname:m}=t;if(u){const d={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${u} ${m}`,createdAt:Date.now()}};n({type:S,payload:d})}}),()=>{r.off("managerJoinToChat")}),[n]),a.useEffect(()=>(r.on("disconnectManager",t=>{if(s){const{_id:o,managerName:u,managerSurname:m}=s,d=t.findIndex(y=>y._id===o);d!==-1&&n({type:L,payload:t[d]});const h={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${u} ${m} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};n({type:S,payload:h})}}),()=>{r.off("disconnectManager")}),[s,n]),a.useEffect(()=>{if(l.current){const t=l.current.scrollHeight,o=l.current.clientHeight;t>o&&(l.current.scrollTop=t-o)}},[s]),i?e.jsxs("div",{children:[e.jsx(le,{children:e.jsxs("section",{ref:l,className:"flex flex-col gap-5 py-5 message-container",children:[s&&e.jsx(R,{type:"text",text:ie,time:s==null?void 0:s.createdAt}),s&&(s==null?void 0:s.messages.map((t,o)=>{const{_id:u=o,messageOwner:m,messageText:d,messageType:h,createdAt:y=Date.now()}=t;return e.jsx(R,{owner:m==="user"?"Ви":m==="Бот"?"Бот":`Менеджер ${s.managerName} ${s.managerSurname}`,type:h,text:d,time:y},u)})),!s&&e.jsx(R,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]})}),e.jsx(_,{isActiveMenu:!s})]}):null};export{ge as default};
