import{P as X,a as U,u as I,b as _,r as a,j as e,L as Y,M as Z,i as A,A as ee,S as B,c as se,d as n,e as S,f as te,Q as $,g as ae,s as ne,h as oe,k as re,l as ie,m as O,B as ce}from"./index-5453649d.js";import{S as le,D as ue,P as me}from"./SearchBtnMini-4d3842eb.js";import{C as de,M as b,a as ge}from"./Container-99035468.js";const H=({isActiveMenu:r})=>{const j=U(),c=I(_),[y,h]=a.useState(!1),[u,s]=a.useState(""),[T,l]=a.useState(1),C=a.useRef(T),[t,o]=a.useState(null),[m,d]=a.useState(!1),[g,f]=a.useState(null),[M,D]=a.useState(!1),w=a.useRef(null),[K,F]=a.useState(!1),R=localStorage.getItem("userId");let N;const v=()=>{c&&(j(se({chatRoomId:c._id,userId:R})),h(!1))},P=i=>{const p=i.target,x=1,G=4;s(p.value);const L=Math.min(G,Math.max(x,p.scrollHeight/24));l(L),C.current=L,n.emit("userTyping",{isTyping:!0}),clearTimeout(N),N=setTimeout(()=>{n.emit("userTyping",{isTyping:!1})},1e3)},E=()=>{if(u.trim()==="")return;const i={userId:R,roomId:c._id,message:{messageOwner:"user",messageType:"text",messageText:u}};j({type:S,payload:i}),n.emit("userMessage",i),s(""),l(1)},k=()=>{if(t){F(!0),D(!0);const i=new FormData;i.append("chatImageURL",t),te(i).then(p=>{const x={userId:R,roomId:c._id,message:{messageOwner:"user",messageType:"image",messageText:p.imageURL}};j({type:S,payload:x}),n.emit("userMessage",x)}).catch(()=>$.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{o(null),d(!1),f(null),F(!1),D(!1)})}},J=i=>{const p=i.target.files[0];o(p),d(!0);const x=URL.createObjectURL(p);f(x)},W=()=>{w.current&&w.current.click()},q=()=>{u.trim()!==""&&l(C.current)},Q=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),M?k():E())},V=()=>{h(!y)},z=()=>{l(1),n.emit("userTyping",{isTyping:!1})};return a.useEffect(()=>{h(r)},[r]),e.jsx(e.Fragment,{children:K?e.jsx(Y,{}):e.jsxs("footer",{className:"absolute bottom-0 w-full",children:[e.jsxs("div",{className:"relative items-center bg-mainColors-staticWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:T,value:u,onChange:P,onKeyDown:Q,onFocus:q,onBlur:z}),!u&&!m&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:V,children:e.jsx(Z,{colorFill:y?A.brand:A.primary})}),e.jsxs("button",{className:"icon-style",onClick:W,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:J,ref:w}),e.jsx(ee,{})]})]}),u&&e.jsx("button",{type:"submit",className:"icon-style",onClick:E,children:e.jsx(B,{})}),m&&e.jsx("button",{type:"submit",className:"icon-style",onClick:k,children:e.jsx(B,{})}),g&&e.jsx("div",{className:"bg-mainColors-staticWhite ml-5 py-5",children:e.jsx("img",{src:g,alt:"Uploaded Image"})})]}),y&&e.jsxs("div",{className:"flex gap-3 py-xs justify-center fade-in",children:[e.jsx(le,{to:"/",disabled:c==null?void 0:c.isChatRoomProcessed,onClick:v,children:"Головне меню"}),e.jsx(ue,{to:"/",onClick:v,children:"Завершити діалог"})]})]})})};H.propTypes={isActiveMenu:X.bool.isRequired};const he=()=>{const r=U(),[j,c]=a.useState(!1),[y,h]=a.useState(!1),u=I(ae),s=I(_),T=I(ne),l=a.useRef(null),C=localStorage.getItem("userId");return a.useEffect(()=>{n.emit("authentication",{token:u}),c(!0)},[u]),n.on("authenticationError",({message:t})=>{$.error(t),c(!1)}),a.useEffect(()=>(n.on("closeChatByManager",({room:t})=>{r({type:oe,payload:{room:t}})}),()=>{n.off("closeChatByManager")}),[r]),a.useEffect(()=>{!s&&T.isOnline===!0&&r(re(C))},[s,r,T.isOnline,C]),a.useEffect(()=>(n.on("managerMessage",({roomId:t,message:o})=>{r({type:S,payload:{roomId:t,message:o}})}),()=>{n.off("managerMessage")}),[r]),a.useEffect(()=>(n.on("managerTyping",({isTyping:t,manager:o})=>{t&&o.id===s.managerId?h(!0):h(!1)}),()=>{n.off("managerTyping")}),[s.managerId]),a.useEffect(()=>(n.on("userStatusChanged",({userId:t,isOnline:o})=>{r({type:ie,payload:{userId:t,isOnline:o}})}),()=>{n.off("userStatusChanged")}),[r]),a.useEffect(()=>(n.on("managerJoinToChat",t=>{r({type:O,payload:t});const{_id:o,managerName:m,managerSurname:d}=t;if(m){const g={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${m} ${d}`,createdAt:Date.now()}};r({type:S,payload:g})}}),()=>{n.off("managerJoinToChat")}),[r]),a.useEffect(()=>(n.on("disconnectManager",t=>{if(s){const{_id:o,managerName:m,managerSurname:d}=s,g=t.findIndex(f=>f._id===o);if(g!==-1){r({type:O,payload:t[g]});const f={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${m} ${d} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};r({type:S,payload:f})}}}),()=>{n.off("disconnectManager")}),[s,r]),a.useEffect(()=>{if(l.current){const t=l.current.scrollHeight,o=l.current.clientHeight;t>o&&(l.current.scrollTop=t-o)}},[s,y]),j?e.jsxs("div",{children:[e.jsx(de,{children:e.jsxs("section",{ref:l,className:"flex flex-col gap-5 py-5 message-container",children:[s&&e.jsx(b,{type:"text",text:ge,time:s==null?void 0:s.createdAt}),s&&(s==null?void 0:s.messages.map((t,o)=>{const{_id:m=o,messageOwner:d,messageText:g,messageType:f,createdAt:M=Date.now()}=t;return e.jsx(b,{owner:d==="user"?"Ви":d==="Бот"?"Бот":`Менеджер ${s.managerName} ${s.managerSurname}`,type:f,text:g,time:M},m)})),y&&e.jsx("div",{children:e.jsx(me,{disabled:!0,children:e.jsxs("div",{className:"flex gap-xs2",children:[e.jsx("div",{className:"font-normal text-sm leading-5 text-textColors-tertiary",children:"Менеджер друкує повідомлення"}),e.jsx(ce,{height:20,width:48,radius:8})]})})}),!s&&e.jsx(b,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]})}),e.jsx(H,{isActiveMenu:!s})]}):null};export{he as default};
