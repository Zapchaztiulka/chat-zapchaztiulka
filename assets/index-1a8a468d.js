import{j as e,P as C,u as W,a as P,b as R,s as K,r as s,c as i,L as ie,M as ce,A as le,S as de,C as ue,d as E,e as me,Q as _,f as ge,g as xe,h as pe,i as fe,k as he,l as be,m as G,B as ye,n as we}from"./index-c7406d72.js";import{B as L}from"./Button-20ea084f.js";import{C as je,M as U,a as ve}from"./Container-b6e9fffd.js";const Ce=()=>e.jsxs("svg",{width:"60",height:"59",viewBox:"0 0 60 59",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("circle",{cx:"30.0002",cy:"29.5227",r:"29.3743",fill:"#FEF3F2"}),e.jsx("circle",{cx:"30.0005",cy:"29.5225",r:"20.0513",fill:"#FEE4E2"}),e.jsx("path",{d:"M30 26.6782V30.5366M30 34.395H30.0097M28.3506 21.7202L20.1804 35.3596C20.012 35.6513 19.9228 35.9821 19.9219 36.3189C19.9209 36.6558 20.0082 36.987 20.175 37.2797C20.3418 37.5723 20.5824 37.8162 20.8727 37.987C21.163 38.1579 21.493 38.2497 21.8299 38.2534H38.1702C38.507 38.2497 38.837 38.1579 39.1274 37.987C39.4177 37.8162 39.6582 37.5723 39.825 37.2797C39.9919 36.987 40.0791 36.6558 40.0782 36.3189C40.0773 35.9821 39.9881 35.6513 39.8197 35.3596L31.6495 21.7202C31.4775 21.4367 31.2354 21.2023 30.9465 21.0396C30.6576 20.877 30.3316 20.7915 30 20.7915C29.6685 20.7915 29.3425 20.877 29.0536 21.0396C28.7647 21.2023 28.5225 21.4367 28.3506 21.7202Z",stroke:"#F04438",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})]}),De=(l,t,u)=>new Promise(y=>{const m=new FileReader;m.readAsDataURL(l),m.onload=r=>{const g=new Image;g.src=r.target.result,g.onload=()=>{const f=document.createElement("canvas"),d=f.getContext("2d"),I=g.width/g.height,D=t/I;f.width=t,f.height=D,d.drawImage(g,0,0,t,D);const h=f.toDataURL("image/jpeg",u);y(h)}}}),Me=l=>{let t=l.length-1;if(t<0||l[t].messageOwner==="user")return null;let u=0;for(;t>=0&&l[t].messageOwner!=="user"&&l[t].messageOwner!=="Бот";)u++,t--;return u||null};const J=({isActiveMenu:l,isOpenModal:t,isTablet:u})=>{const y=W(),m=P(),r=R(K),[g,f]=s.useState(!1),[d,I]=s.useState(""),[D,h]=s.useState(1),a=s.useRef(D),[M,w]=s.useState(null),[b,N]=s.useState(!1),[k,n]=s.useState(null),[o,x]=s.useState(!1),p=s.useRef(null),[j,v]=s.useState(!1),[O,H]=s.useState(!1),[$,Q]=s.useState(null),q=localStorage.getItem("userId");let Z;const F=s.useCallback(c=>{i.emit("userTyping",{isTyping:c,roomId:r==null?void 0:r._id}),H(c)},[r==null?void 0:r._id]),X=c=>{const T=c.target,S=1,re=4;I(T.value);const z=Math.min(re,Math.max(S,T.scrollHeight/24));h(z),a.current=z,O||F(!0),clearTimeout($);const oe=setTimeout(()=>{F(!1)},3e3);Q(oe)},A=()=>{if(d.trim()==="")return;const c={userId:q,roomId:r==null?void 0:r._id,message:{messageOwner:"user",messageType:"text",messageText:d}};y({type:E,payload:c}),i.emit("userMessage",c),F(!1),I(""),h(1)},B=()=>{if(M){v(!0),x(!0);const c=new FormData;c.append("chatImageURL",M),me(c).then(T=>{const S={userId:q,roomId:r._id,message:{messageOwner:"user",messageType:"image",messageText:T.imageURL}};y({type:E,payload:S}),i.emit("userMessage",S),F(!1)}).catch(()=>_.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{w(null),N(!1),n(null),v(!1),x(!1)})}},Y=async c=>{const T=c.target.files[0];w(T),N(!0);try{const S=await De(T,250,.8);n(S)}catch{_.error("Помилка завантаження фото. Будь-ласка повторіть спробу")}},ee=()=>{p.current&&p.current.click()},te=()=>{d.trim()!==""&&h(a.current)},se=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),o?B():A())},ae=()=>{f(!g)},ne=()=>{h(1),F(!1),clearTimeout(Z)};return s.useEffect(()=>{f(l)},[l]),e.jsx(e.Fragment,{children:j?e.jsx(ie,{}):e.jsxs("footer",{className:"absolute bottom-[0] w-full bg-bgWhite",children:[r&&e.jsxs("div",{className:"relative items-center",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:D,value:d,onChange:X,onKeyDown:se,onFocus:te,onBlur:ne}),!d&&!b&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",className:"icon-style button-wrapper",style:{right:"44px"},onClick:ae,children:[e.jsx(ce,{activeMenu:g}),e.jsx("div",{className:`description hidden absolute bottom-[100%] right-[0%] text-textContrast \r
                       bg-bgGreyDark p-xs2 rounded-medium whitespace-nowrap z-10`,children:g?"Сховати меню":"Показати меню"})]}),e.jsxs("button",{className:"icon-style button-wrapper",onClick:ee,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:Y,ref:p}),e.jsx(le,{}),e.jsx("div",{className:`description hidden absolute bottom-[100%] right-[0%] text-textContrast \r
                       bg-bgGreyDark p-xs2 rounded-medium whitespace-nowrap z-10`,children:"Прикріпити фото .jpg, .jpeg, .png, .gif"})]})]}),(b||d)&&e.jsxs("button",{type:"submit",className:"icon-style button-wrapper z-10",onClick:d&&b?()=>{A(),B()}:d?A:B,children:[e.jsx(de,{}),e.jsx("div",{className:`description hidden absolute bottom-[100%] right-[0%] text-textContrast \r
                       bg-bgGreyDark p-xs2 rounded-medium whitespace-nowrap z-10`,children:"Відправити повідомлення"})]}),k&&e.jsx("div",{className:"ml-s py-sPlus",children:e.jsxs("div",{className:"relative",children:[e.jsx("img",{className:"border-1 border-solid border-borderDefault rounded-minimal",src:k,alt:"Uploaded Image"}),e.jsx("button",{className:`absolute top-[-8px] left-[242px] border-1 bg-bgWhite border-solid\r
                               border-borderDefault rounded-[50%] cursor-pointer hover:bg-bgHoverGrey\r
                               hover:border-borderHover transition-colors duration-300`,onClick:()=>{n(null),N(!1)},children:e.jsx(ue,{})})]})})]}),g&&e.jsxs("div",{className:"flex gap-xs py-xs justify-center fade-in",children:[e.jsx(L,{buttonType:"secondary",text:"Головне меню",className:`font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors 
                duration-300 focus:outline-none min-w-[150px] h-[48px] bg-bgWhite text-textBrand border-solid border-1
                 border-borderDefaultBlue py-xs leading-6 hover:bg-bgHoverGrey focus:shadow-btFocus
                 ${(r==null?void 0:r.isChatRoomProcessed)&&"text-textDisabled border-borderDisabled bg-bgDisable cursor-not-allowed pointer-events-none"} ${u?"px-m":"px-s"}`,onClick:()=>m("/")}),e.jsx(L,{buttonType:"desctructive",className:`font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors 
                            duration-300  focus:outline-none min-w-[150px] h-[48px]  py-xs leading-6 
                            ${u?"px-m":"px-s"} 
                            ${r?"bg-bgDefaultDestructive text-textContrast hover:bg-bgHoverDestructive focus:bg-bgDefaultDestructive focus:shadow-btFocus":"bg-bgDisable text-textDisabled border-solid  border-1 border-borderDisabled cursor-not-allowed hover:bg-bgDisable"}`,text:"Завершити діалог",onClick:()=>t()})]})]})})};J.propTypes={isActiveMenu:C.bool.isRequired,isOpenModal:C.func.isRequired,onFinishChat:C.func,isTablet:C.bool.isRequired};const Te=document.getElementById("modal-root"),V=({onFinishChat:l,closeModal:t,isTablet:u})=>{s.useEffect(()=>{const m=r=>{r.code==="Escape"&&t()};return window.addEventListener("keydown",m),()=>{window.removeEventListener("keydown",m)}},[t]);const y=m=>{m.target===m.currentTarget&&t()};return ge.createPortal(e.jsx("div",{onMouseDown:y,className:"fixed z-40 top-[0] left-[0] w-[100vw] h-[100vh] bg-aditional1",children:e.jsxs("div",{className:`absolute z-30 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
                   flex flex-col gap-m2 py-m h-auto items-center justify-center
                 bg-bgWhite rounded-medium ${u?"w-[400px] px-s":"w-[350px] px-xs"}`,children:[e.jsxs("div",{className:"flex flex-col gap-xs items-center justify-center",children:[e.jsx(Ce,{}),e.jsxs("div",{className:"flex flex-col gap-xs2 items-center justify-center",children:[e.jsx("h4",{className:"font-500 text-heading4 text-textPrimary",children:"Завершити чат з оператором?"}),e.jsx("p",{className:"font-400 text-body text-textSecondary text-center",children:"Ви впевнені, що хочете завершити діалог з оператором?"})]})]}),e.jsxs("div",{className:"flex gap-xs justify-between",children:[e.jsx(L,{buttonType:"secondary-gray",className:`font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors 
                       duration-300 focus:outline-none min-w-[150px] bg-bgWhite text-textPrimary 
                       border-solid border-1 border-borderDefault py-xs leading-6 hover:bg-bgHoverGrey
                       focus:shadow-btFocus  active:bg-bgPressedGrey active:border-borderDefault h-[48px] ${u?"px-m":"px-s"}`,text:"Скасувати",onClick:t}),e.jsx(L,{buttonType:"desctructive",className:`font-500 rounded-medium flex justify-center items-center gap-xs2 transition-colors
                       duration-300 focus:outline-none min-w-[150px] text-textContrast bg-bgDefaultDestructive
                       py-xs leading-6 hover:bg-bgHoverDestructive focus:bg-bgDefaultDestructive 
                       focus:shadow-btFocus disabled:border-solid  disabled:border-1 disabled:border-borderDisabled
                     active:bg-bgPressedDestructive h-[48px] ${u?"px-m":"px-s"}`,text:"Так, завершити",onClick:()=>l()})]})]})}),Te)};V.propTypes={onFinishChat:C.func.isRequired,closeModal:C.func.isRequired,isTablet:C.bool.isRequired};const Se=({isTablet:l})=>{const t=W(),u=P(),[y,m]=s.useState(!1),[r,g]=s.useState(!1),[f,d]=s.useState(!1),[I,D]=s.useState(!0),h=R(xe),a=R(K),M=R(pe),w=s.useRef(null),b=localStorage.getItem("userId");s.useEffect(()=>{if(a){const{messages:n}=a,o=Me(n);i.emit("countUnreadManagerMessages",{userId:b,countUnreadManagerMessages:o})}},[a,b]),s.useEffect(()=>{i.emit("authentication",{token:h}),m(!0)},[h]),i.on("authenticationError",({message:n})=>{_.error(n),m(!1)}),s.useEffect(()=>(i.on("closeChatByManager",({room:n})=>{t({type:fe,payload:{room:n}})}),()=>{i.off("closeChatByManager")}),[t]),s.useEffect(()=>{!a&&M.isOnline===!0&&t(he(b))},[a,t,M.isOnline,b]),s.useEffect(()=>(i.on("managerMessage",({roomId:n,message:o})=>{t({type:E,payload:{roomId:n,message:o}})}),()=>{i.off("managerMessage")}),[t]),s.useEffect(()=>(i.on("managerTyping",({isTyping:n,roomId:o})=>{const{_id:x}=a;g(!!(n&&x&&o===x))}),()=>{i.off("managerTyping")}),[a]),s.useEffect(()=>(i.on("userStatusChanged",({userId:n,isOnline:o})=>{t({type:be,payload:{userId:n,isOnline:o}})}),()=>{i.off("userStatusChanged")}),[t]),s.useEffect(()=>(i.on("managerJoinToChat",n=>{t({type:G,payload:n});const{_id:o,managerName:x,managerSurname:p}=n;if(x){const j={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${x} ${p}`,createdAt:Date.now()}};t({type:E,payload:j})}}),()=>{i.off("managerJoinToChat")}),[t]),s.useEffect(()=>(i.on("disconnectManager",n=>{const{_id:o,managerName:x,managerSurname:p}=a;if(a){const j=n.findIndex(v=>v._id===o);if(j!==-1){t({type:G,payload:n[j]});const v={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${x} ${p} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};t({type:E,payload:v})}}}),()=>{i.off("disconnectManager")}),[a,t]);const N=()=>{a&&(t(we({chatRoomId:a._id,userId:b,username:M.username,userSurname:M.userSurname})),D(!1),d(!1),u("/"))},k=()=>d(!0);return s.useEffect(()=>{if(w.current){const n=w.current.scrollHeight,o=w.current.clientHeight;n>o&&(w.current.scrollTop=n-o)}},[a,r]),y?e.jsxs("div",{children:[e.jsxs(je,{children:[e.jsxs("section",{ref:w,className:`flex flex-col gap-sPlus 
          ${l?"max-h-[83vh] py-sPlus":"max-h-[400px] py-s"}
           message-container`,children:[a&&e.jsx(U,{type:"text",text:ve,time:a==null?void 0:a.createdAt}),a&&(a==null?void 0:a.messages.map((n,o)=>{const{_id:x=o,messageOwner:p,messageText:j,messageType:v,createdAt:O}=n,{managerName:H,managerSurname:$}=a;return e.jsx(U,{owner:p==="user"?"Ви":p==="Бот"?"Бот":`Менеджер ${H} ${$}`,type:v,text:j,time:O},x)})),r&&e.jsxs("div",{className:"flex gap-xs2",children:[e.jsx("div",{className:"font-400 text-caption text-textTertiary",children:"Менеджер друкує повідомлення"}),e.jsx(ye,{height:20,width:48,radius:8})]}),!a&&e.jsx(U,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]}),f&&e.jsx(V,{onFinishChat:N,closeModal:()=>d(!1),isTablet:l})]}),e.jsx(J,{isActiveMenu:I,isOpenModal:k,onFinishChat:N,isTablet:l})]}):null};Se.propTypes={isTablet:C.bool.isRequired};export{Se as default};
