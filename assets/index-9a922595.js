import{P as z,a as U,u as I,b as O,r as a,j as e,L as G,M as X,i as v,A as Y,S as L,c as Z,d as j,e as r,f as ee,Q as _,g as se,s as te,h as ae,k as ne,l as oe,m as A}from"./index-ed6bb612.js";import{S as re,D as ce}from"./SearchBtnMini-ba03ccd2.js";import{C as le,M as R,a as ie}from"./Container-2490305a.js";const $=({isActiveMenu:n})=>{const p=U(),i=I(O),[h,t]=a.useState(!1),[l,x]=a.useState(""),[C,s]=a.useState(1),o=a.useRef(C),[u,m]=a.useState(null),[d,g]=a.useState(!1),[S,T]=a.useState(null),[B,b]=a.useState(!1),M=a.useRef(null),[H,D]=a.useState(!1),w=localStorage.getItem("userId"),F=()=>{i&&(p(Z({chatRoomId:i._id,userId:w})),t(!1))},K=c=>{const f=c.target,y=1,V=4;x(f.value);const N=Math.min(V,Math.max(y,f.scrollHeight/24));s(N),o.current=N},k=()=>{if(l.trim()==="")return;const c={userId:w,roomId:i._id,message:{messageOwner:"user",messageType:"text",messageText:l}};p({type:j,payload:c}),r.emit("userMessage",c),x(""),s(1)},E=()=>{if(u){D(!0),b(!0);const c=new FormData;c.append("chatImageURL",u),ee(c).then(f=>{const y={userId:w,roomId:i._id,message:{messageOwner:"user",messageType:"image",messageText:f.imageURL}};p({type:j,payload:y}),r.emit("userMessage",y)}).catch(()=>_.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{m(null),g(!1),T(null),D(!1),b(!1)})}},J=c=>{const f=c.target.files[0];m(f),g(!0);const y=URL.createObjectURL(f);T(y)},W=()=>{M.current&&M.current.click()},q=()=>{l.trim()!==""&&s(o.current)},P=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),B?E():k())},Q=()=>{t(!h)};return a.useEffect(()=>{t(n)},[n]),e.jsx(e.Fragment,{children:H?e.jsx(G,{}):e.jsxs("footer",{className:"absolute bottom-0 w-full",children:[e.jsxs("div",{className:"relative items-center bg-mainColors-staticWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:C,value:l,onChange:K,onKeyDown:P,onFocus:q,onBlur:()=>s(1)}),!l&&!d&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:Q,children:e.jsx(X,{colorFill:h?v.brand:v.primary})}),e.jsxs("button",{className:"icon-style",onClick:W,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:J,ref:M}),e.jsx(Y,{})]})]}),l&&e.jsx("button",{type:"submit",className:"icon-style",onClick:k,children:e.jsx(L,{})}),d&&e.jsx("button",{type:"submit",className:"icon-style",onClick:E,children:e.jsx(L,{})}),S&&e.jsx("div",{className:"bg-mainColors-staticWhite ml-5 py-5",children:e.jsx("img",{src:S,alt:"Uploaded Image"})})]}),h&&e.jsxs("div",{className:"flex gap-3 py-xs justify-center fade-in",children:[e.jsx(re,{to:"/",disabled:i==null?void 0:i.isChatRoomProcessed,onClick:F,children:"Головне меню"}),e.jsx(ce,{to:"/",onClick:F,children:"Завершити діалог"})]})]})})};$.propTypes={isActiveMenu:z.bool.isRequired};const ge=()=>{const n=U(),p=I(se),[i,h]=a.useState(!1),t=I(O),l=a.useRef(null),x=localStorage.getItem("userId"),C=I(te);return a.useEffect(()=>{r.emit("authentication",{token:p}),h(!0)},[p]),r.on("authenticationError",({message:s})=>{_.error(s),h(!1)}),a.useEffect(()=>(r.on("closeChatByManager",({room:s})=>{n({type:ae,payload:{room:s}})}),()=>{r.off("closeChatByManager")}),[n]),a.useEffect(()=>{!t&&C.isOnline===!0&&n(ne(x))},[t,n,C.isOnline,x]),a.useEffect(()=>(r.on("managerMessage",({roomId:s,message:o})=>{n({type:j,payload:{roomId:s,message:o}})}),()=>{r.off("managerMessage")}),[n]),a.useEffect(()=>(r.on("userStatusChanged",({userId:s,isOnline:o})=>{n({type:oe,payload:{userId:s,isOnline:o}})}),()=>{r.off("userStatusChanged")}),[n]),a.useEffect(()=>(r.on("managerJoinToChat",s=>{n({type:A,payload:s});const{_id:o,managerName:u,managerSurname:m}=s;if(u){const d={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${u} ${m}`,createdAt:Date.now()}};n({type:j,payload:d})}}),()=>{r.off("managerJoinToChat")}),[n]),a.useEffect(()=>(r.on("disconnectManager",s=>{if(t){const{_id:o,managerName:u,managerSurname:m}=t,d=s.findIndex(g=>g._id===o);if(d!==-1){n({type:A,payload:s[d]});const g={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${u} ${m} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};n({type:j,payload:g})}}}),()=>{r.off("disconnectManager")}),[t,n]),a.useEffect(()=>{if(l.current){const s=l.current.scrollHeight,o=l.current.clientHeight;s>o&&(l.current.scrollTop=s-o)}},[t]),i?e.jsxs("div",{children:[e.jsx(le,{children:e.jsxs("section",{ref:l,className:"flex flex-col gap-5 py-5 message-container",children:[t&&e.jsx(R,{type:"text",text:ie,time:t==null?void 0:t.createdAt}),t&&(t==null?void 0:t.messages.map((s,o)=>{const{_id:u=o,messageOwner:m,messageText:d,messageType:g,createdAt:S=Date.now()}=s;return e.jsx(R,{owner:m==="user"?"Ви":m==="Бот"?"Бот":`Менеджер ${t.managerName} ${t.managerSurname}`,type:g,text:d,time:S},u)})),!t&&e.jsx(R,{type:"text",text:"Менеджер завершив чат. Для продовження перейдіть в Головне меню",time:Date.now()})]})}),e.jsx($,{isActiveMenu:!t})]}):null};export{ge as default};
