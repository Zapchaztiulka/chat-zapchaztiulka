import{a as v,u as w,b as A,r as a,j as e,L as q,M as z,i as N,A as G,S as k,c as P,d as j,e as c,f as X,Q as U,g as Y,h as Z,k as ee,l as E}from"./index-e02f093c.js";import{S as se,D as te}from"./SearchBtnMini-e622cd4f.js";import{C as ae,M as L,a as ne}from"./Container-641910d8.js";const oe=()=>{const n=v(),d=w(A),[x,S]=a.useState(!1),[s,i]=a.useState(""),[y,t]=a.useState(1),o=a.useRef(y),[l,m]=a.useState(null),[u,f]=a.useState(!1),[p,M]=a.useState(null),[_,R]=a.useState(!1),[$,T]=a.useState(!1),C=a.useRef(null),I=localStorage.getItem("userId"),O=()=>{d&&n(P({chatRoomId:d._id,userId:I}))},H=r=>{const g=r.target,h=1,V=4;i(g.value);const D=Math.min(V,Math.max(h,g.scrollHeight/24));t(D),o.current=D},b=()=>{if(s.trim()==="")return;const r={userId:I,roomId:d._id,message:{messageOwner:"user",messageType:"text",messageText:s}};n({type:j,payload:r}),c.emit("userMessage",r),i(""),t(1)},F=()=>{if(l){T(!0),R(!0);const r=new FormData;r.append("chatImageURL",l),X(r).then(g=>{const h={userId:I,roomId:d._id,message:{messageOwner:"user",messageType:"image",messageText:g.imageURL}};n({type:j,payload:h}),c.emit("userMessage",h)}).catch(()=>U.error("Не вдалося завантажити фото. Спробуйте повторити")).finally(()=>{m(null),f(!1),M(null),T(!1),R(!1)})}},B=r=>{const g=r.target.files[0];m(g),f(!0);const h=URL.createObjectURL(g);M(h)},K=()=>{C.current&&C.current.click()},J=()=>{s.trim()!==""&&t(o.current)},W=r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),_?F():b())},Q=()=>{S(!x)};return e.jsx(e.Fragment,{children:$?e.jsx(q,{}):e.jsxs("footer",{className:"absolute bottom-0 w-full",children:[e.jsxs("div",{className:"relative items-center bg-mainColors-staticWhite",children:[e.jsx("textarea",{className:"input-style",type:"text",placeholder:"Введіть ваше повідомлення",rows:y,value:s,onChange:H,onKeyDown:W,onFocus:J,onBlur:()=>t(1)}),!s&&!u&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"icon-style",style:{right:"44px"},onClick:Q,children:e.jsx(z,{colorFill:x?N.brand:N.primary})}),e.jsxs("button",{className:"icon-style",onClick:K,children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:B,ref:C}),e.jsx(G,{})]})]}),s&&e.jsx("button",{type:"submit",className:"icon-style",onClick:b,children:e.jsx(k,{})}),u&&e.jsx("button",{type:"submit",className:"icon-style",onClick:F,children:e.jsx(k,{})}),p&&e.jsx("div",{className:"bg-mainColors-staticWhite ml-5 py-5",children:e.jsx("img",{src:p,alt:"Uploaded Image"})})]}),x&&e.jsxs("div",{className:"flex gap-3 py-xs justify-center fade-in",children:[e.jsx(se,{disabled:!0,children:"Головне меню"}),e.jsx(te,{to:"/",onClick:O,children:"Завершити діалог"})]})]})})},ie=()=>{const n=v(),d=w(Y),[x,S]=a.useState(!1),s=w(A),i=a.useRef(null),y=localStorage.getItem("userId");return a.useEffect(()=>{c.emit("authentication",{token:d}),S(!0)},[d]),c.on("authenticationError",({message:t})=>{U.error(t),S(!1)}),a.useEffect(()=>{s||n(Z(y))},[s,n,y]),a.useEffect(()=>(c.on("managerMessage",({roomId:t,message:o})=>{n({type:j,payload:{roomId:t,message:o}})}),()=>{c.off("managerMessage")}),[n]),a.useEffect(()=>(c.on("userStatusChanged",({userId:t,isOnline:o})=>{n({type:ee,payload:{userId:t,isOnline:o}})}),()=>{c.off("userStatusChanged")}),[n]),a.useEffect(()=>(c.on("managerJoinToChat",t=>{n({type:E,payload:t});const{_id:o,managerName:l,managerSurname:m}=s;if(l){const u={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`До чату приєднався менеджер ${l} ${m}`,createdAt:Date.now()}};n({type:j,payload:u})}}),()=>{c.off("managerJoinToChat")}),[s,n]),a.useEffect(()=>(c.on("disconnectManager",t=>{if(s){const{_id:o,managerName:l,managerSurname:m}=s,u=t.findIndex(p=>p._id===o);n({type:E,payload:t[u]});const f={roomId:o,message:{messageOwner:"Бот",messageType:"text",messageText:`Менеджер ${l} ${m} від'єднався. Очікуйте підключення менеджера...`,createdAt:Date.now()}};n({type:j,payload:f})}}),()=>{c.off("disconnectManager")}),[s,n]),a.useEffect(()=>{if(i.current){const t=i.current.scrollHeight,o=i.current.clientHeight;t>o&&(i.current.scrollTop=t-o)}},[s]),x?e.jsxs("div",{children:[e.jsx(ae,{children:e.jsxs("section",{ref:i,className:"flex flex-col gap-5 py-5 message-container",children:[e.jsx(L,{type:"text",text:ne,time:s==null?void 0:s.createdAt}),s&&(s==null?void 0:s.messages.map((t,o)=>{const{_id:l=o,messageOwner:m,messageText:u,messageType:f,createdAt:p=Date.now()}=t;return e.jsx(L,{owner:m==="user"?"Ви":`Менеджер ${s.managerName} ${s.managerSurname}`,type:f,text:u,time:p},l)}))]})}),e.jsx(oe,{})]}):null};export{ie as default};
